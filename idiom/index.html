<!-- index.html ¬∑ Draggable Chinese Cards (jQuery + jQuery‚ÄëUI)
 ÂäüËÉΩÔºö
 1) È°åÁõÆÔºö6 Â≠ó‰∫ÇÂ∫èÔºàÂâç 4‚ÄØÂ≠óÁÇ∫Ê≠£Ëß£Ôºâ
 2) ÊãñÂÖ•„ÄåÁ≠îÊ°àÂçÄ„ÄçÊéíÂá∫Ê≠£Á¢∫ 4 Â≠ó ‚Üí ‚úî Ê≠£Á¢∫„ÄÅË®àÊôÇ
 3) ÁµêÊùüÊ¢ù‰ª∂Ôºö
    ‚Ä¢ ÊàêÂäüÊéíÂá∫Ê≠£Á¢∫ 4 Â≠óÔºàstatus = "solved"Ôºâ
    ‚Ä¢ Ë∂ÖÈÅé 15 Áßí‰ªçÊú™ÂÆåÊàêÔºàstatus = "timeout"Ôºâ
    ‚Üí ÁµêÊùüÊôÇÈÄèÈÅé `fetch` Â∞áÁ¥ÄÈåÑ **POST** Âà∞‰º∫ÊúçÂô® `/log` Á´ØÈªû (JSON body)
      Ëã•‰º∫ÊúçÂô®‰∏çÂèØÁî® ‚Üí ÂÇôÊè¥‰∏ãËºâ `log_<epoch>.txt`
 4) Á¥ØË®à 10 È°åÂç≥ÁµêÊùüÔºàÂÅúÁî®„ÄåÊèõ‰∏ÄÈ°å„ÄçÔºâ
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Draggable Chinese Cards</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css" />
  <style>
    /* --- Âü∫Êú¨Ê®£Âºè‰øùÊåÅ‰∏çËÆä --- */
    html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#f3f4f6;font-family:"Noto Sans TC",sans-serif}
    .card{width:150px;height:150px;background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.15);position:absolute;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:700;cursor:move;user-select:none}
    #answerZone{position:fixed;bottom:120px;left:50%;transform:translateX(-50%);width:700px;height:170px;border:3px dashed #9ca3af;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:20px;pointer-events:none}
    #randomBtn{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:12px 22px;font-size:18px;background:#2563eb;color:#fff;border:none;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,.25);cursor:pointer}
    #randomBtn:hover{background:#1d4ed8}
    #result{position:fixed;top:20px;left:50%;transform:translateX(-50%);font-size:26px;font-weight:700;color:#16a34a;display:none}
    #timeoutMsg{position:fixed;top:60px;left:50%;transform:translateX(-50%);font-size:22px;font-weight:600;color:#dc2626;display:none;white-space:nowrap}
    #scoreBoard{position:fixed;top:20px;right:30px;font-size:22px;font-weight:600;color:#1f2937}
    #timer{position:fixed;top:60px;right:30px;font-size:20px;color:#374151}
  </style>
</head>
<body>
  <div id="result">‚úî Ê≠£Á¢∫ÔºÅ</div>
  <div id="timeoutMsg"></div>
  <div id="scoreBoard">0 / 10</div>
  <div id="timer">‚è± 0 s</div>
  <div id="answerZone">Â∞á 4 ÂºµÊ≠£Á¢∫Â≠óÂç°ÊãñÂà∞Ê≠§Ëôï‰∏¶‰æùÂ∫èÊéíÂàó</div>
  <button id="randomBtn">Êèõ‰∏ÄÈ°å</button>

<script>
$(function(){
  const layout=[{x:40,y:40},{x:220,y:40},{x:400,y:40},{x:40,y:240},{x:220,y:240},{x:400,y:240}],CARD_H=150,TIME_LIMIT=15;
  let idioms=[],answer='',question='',score=0,startTime,timerID,logged=false,solved=false;

  /* ---------- ‰º∫ÊúçÂô®Ë®òÈåÑ ---------- */
  async function sendToServer(obj){
    try{
      const res=await fetch('/log',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(obj)
      });
      if(!res.ok) throw new Error(res.statusText);
      console.log('%cüöÄ Â∑≤ÈÄÅÂá∫Ëá≥‰º∫ÊúçÂô®','color:#0ea5e9',obj);
    }catch(err){
      console.warn('‰º∫ÊúçÂô®ÂØ´ÂÖ•Â§±ÊïóÔºåÊîπÁÇ∫‰∏ãËºâ',err);
      fallbackDownload(obj);
    }
  }
  function fallbackDownload(data){
    const blob=new Blob([JSON.stringify(data)],{type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=`log_${Date.now()}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  /* ---------- Â∑•ÂÖ∑ ---------- */
  const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;};
  function placed(){const top=$('#answerZone').position().top,bot=top+$('#answerZone').outerHeight();const arr=[];$('.card').each(function(){const p=$(this).position();const mid=p.top+CARD_H/2;if(mid>top&&mid<bot) arr.push({l:p.left,ch:$(this).text()});});arr.sort((a,b)=>a.l-b.l);return arr.map(o=>o.ch).join('');}

  /* ---------- Ë®àÊôÇ ---------- */
  function startTimer(){startTime=Date.now();logged=false;$('#timeoutMsg').hide();$('#timer').text('‚è± 0 s');clearInterval(timerID);timerID=setInterval(()=>{const s=Math.floor((Date.now()-startTime)/1000);$('#timer').text(`‚è± ${s} s`);if(s>=TIME_LIMIT&&!logged){timeout(s);} },1000);}  
  function timeout(sec){$('#timeoutMsg').text(`‚ö†Ô∏è Ë∂ÖÈÅé ${TIME_LIMIT} ÁßíÔºÅÁ≠îÊ°àÔºö${answer}`).show();end('timeout',sec);}  

  /* ---------- ÁµêÊùü ---------- */
  async function end(status,sec){if(logged) return;logged=true;clearInterval(timerID);
    const entry={timestamp:new Date().toISOString(),seconds:sec,status,question,answer,final:placed()||''};
    await sendToServer(entry);
  }

  /* ---------- ÂàÜÊï∏ ---------- */
  function updScore(){$('#scoreBoard').text(`${score} / 10`);if(score>=10){$('#scoreBoard').css('color','#16a34a');$('#randomBtn').prop('disabled',true).text('Â∑≤ÂÆåÊàê 10 È°å');clearInterval(timerID);}}

  /* ---------- Ë≥áÊñô ---------- */
  $.getJSON('combined_idioms_fixed.json').done(list=>{idioms=list;next();});
  $('#randomBtn').on('click',()=>{if(score<10) next();});

  function next(){let item=null;for(let i=0;i<40;i++){const c=idioms[Math.random()*idioms.length|0];if((c.generated||'').length>=6){item=c;break;}}if(!item){alert('Ë≥áÊñô‰∏çË∂≥');return;}answer=item.generated.slice(0,4);question=shuffle(item.generated.slice(0,6).split('')).join('');render(question.split(''));startTimer();}
  function render(chars){$('.card').remove();$('#result').hide();$('#answerZone').css('border-color','#9ca3af');solved=false;chars.forEach((ch,i)=>$('<div class="card"/>').text(ch).css({left:layout[i].x,top:layout[i].y}).appendTo('body').draggable({containment:'body',stop:check}));}

  function check(){if(solved||logged) return;const cur=placed();if(cur.length<4) return;if(cur.slice(0,4)===answer){solved=true;score++;updScore();$('#result').show();$('#answerZone').css('border-color','#16a34a');const sec=Math.floor((Date.now()-startTime)/1000);end('solved',sec);} }
});
</script>
</body>
</html>

<!-- index.html Â· Draggable Chinese Cards (jQuery + jQueryâ€‘UI)
 åŠŸèƒ½ï¼š
 1) é¡Œç›®ï¼š6 å­—äº‚åºï¼ˆå‰ 4â€¯å­—ç‚ºæ­£è§£ï¼‰
 2) æ‹–å…¥ã€Œç­”æ¡ˆå€ã€æ’å‡ºæ­£ç¢º 4 å­— â†’ âœ” æ­£ç¢ºã€è¨ˆæ™‚
 3) çµæŸæ¢ä»¶ï¼šsolved / timeout (15â€¯s) â†’ å°‡ç´€éŒ„ POST `/log`ï¼Œå¤±æ•—å‰‡ä¸‹è¼‰
 4) **å¤–éƒ¨è®€æª”**ï¼šä½¿ç”¨ `fetch('combined_idioms_fixed.json')`ï¼Œéœ€åœ¨ http(s) ä¼ºæœå™¨ç’°å¢ƒåŸ·è¡Œï¼Œé¿å… file:// CORS
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Draggable Chinese Cards</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css" />
  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;background:#f3f4f6;font-family:"Noto Sans TC",sans-serif}
    .card{width:150px;height:150px;background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.15);position:absolute;display:flex;align-items:center;justify-content:center;font-size:48px;font-weight:700;cursor:move;user-select:none}
    #answerZone{position:fixed;bottom:120px;left:50%;transform:translateX(-50%);width:700px;height:170px;border:3px dashed #9ca3af;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#6b7280;font-size:20px;pointer-events:none}
    #randomBtn{position:fixed;bottom:30px;left:50%;transform:translateX(-50%);padding:12px 22px;font-size:18px;background:#2563eb;color:#fff;border:none;border-radius:10px;box-shadow:0 3px 8px rgba(0,0,0,.25);cursor:pointer}
    #randomBtn:hover{background:#1d4ed8}
    #result{position:fixed;top:20px;left:50%;transform:translateX(-50%);font-size:26px;font-weight:700;color:#16a34a;display:none}
    #timeoutMsg{position:fixed;top:60px;left:50%;transform:translateX(-50%);font-size:22px;font-weight:600;color:#dc2626;display:none;white-space:nowrap}
    #scoreBoard{position:fixed;top:20px;right:30px;font-size:22px;font-weight:600;color:#1f2937}
    #timer{position:fixed;top:60px;right:30px;font-size:20px;color:#374151}
  </style>
</head>
<body>
  <div id="result">âœ” æ­£ç¢ºï¼</div>
  <div id="timeoutMsg"></div>
  <div id="scoreBoard">0 / 10</div>
  <div id="timer">â± 0 s</div>
  <div id="answerZone">å°‡ 4 å¼µæ­£ç¢ºå­—å¡æ‹–åˆ°æ­¤è™•ä¸¦ä¾åºæ’åˆ—</div>
  <button id="randomBtn">æ›ä¸€é¡Œ</button>

<script>
$(function(){
  const layout=[{x:40,y:40},{x:220,y:40},{x:400,y:40},{x:40,y:240},{x:220,y:240},{x:400,y:240}],CARD_H=150,TIME_LIMIT=15;
  let idioms=[],answer='',question='',score=0,startTime,timerID,logged=false,solved=false;

  /* ---------- ä¼ºæœå™¨è¨˜éŒ„ ---------- */
  async function sendToServer(obj){
    try{const r=await fetch('/log',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});if(!r.ok)throw new Error(r.statusText);console.log('ğŸš€ å·²é€å‡ºè‡³ä¼ºæœå™¨',obj);}catch(e){console.warn('ä¼ºæœå™¨å¤±æ•—ï¼Œä¸‹è¼‰å‚™ä»½',e);downloadFallback(obj);} }
  function downloadFallback(data){const b=new Blob([JSON.stringify(data)],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`log_${Date.now()}.txt`;a.click();}

  /* ---------- å·¥å…· ---------- */
  const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;};
  function placed(){const top=$('#answerZone').position().top,bot=top+$('#answerZone').outerHeight();const arr=[];$('.card').each(function(){const p=$(this).position();const mid=p.top+CARD_H/2;if(mid>top&&mid<bot)arr.push({l:p.left,ch:$(this).text()});});arr.sort((a,b)=>a.l-b.l);return arr.map(o=>o.ch).join('');}

  function startTimer(){startTime=Date.now();logged=false;$('#timeoutMsg').hide();$('#timer').text('â± 0 s');clearInterval(timerID);timerID=setInterval(()=>{const s=Math.floor((Date.now()-startTime)/1000);$('#timer').text(`â± ${s} s`);if(s>=TIME_LIMIT&&!logged)timeout(s);},1000);}  
  function timeout(sec){$('#timeoutMsg').text(`âš ï¸ è¶…é ${TIME_LIMIT} ç§’ï¼ç­”æ¡ˆï¼š${answer}`).show();end('timeout',sec);}  
  async function end(status,sec){if(logged)return;logged=true;clearInterval(timerID);await sendToServer({timestamp:new Date().toISOString(),seconds:sec,status,question,answer,final:placed()||''});}
  function updScore(){$('#scoreBoard').text(`${score} / 10`);if(score>=10){$('#scoreBoard').css('color','#16a34a');$('#randomBtn').prop('disabled',true).text('å·²å®Œæˆ 10 é¡Œ');clearInterval(timerID);}}

  $('#randomBtn').on('click',()=>{if(score<10)init();});

  /* ---------- å¤–éƒ¨è¼‰å…¥ JSON ---------- */
  fetch('combined_idioms_fixed.json').then(r=>r.json()).then(data=>{idioms=data;init();}).catch(err=>{alert('è®€å– JSON å¤±æ•—ï¼Œè«‹é€é http(s) ä¼ºæœå™¨é–‹å•Ÿ\n'+err);});

  function init(){if(!idioms.length){alert('è³‡æ–™ä¸è¶³');return;}let it=null;for(let i=0;i<40;i++){const c=idioms[Math.random()*idioms.length|0];if((c.generated||'').length>=6){it=c;break;}}if(!it){alert('æ²’æœ‰è¶³å¤ é•·åº¦ç‰‡èª');return;}answer=it.generated.slice(0,4);question=shuffle(it.generated.slice(0,6).split('')).join('');render(question.split(''));startTimer();}
  function render(chars){$('.card').remove();$('#result').hide();$('#answerZone').css('border-color','#9ca3af');solved=false;chars.forEach((ch,i)=>$('<div class="card"/>').text(ch).css({left:layout[i].x,top:layout[i].y}).appendTo('body').draggable({containment:'body',stop:check}));}
  function check(){if(solved||logged)return;const cur=placed();if(cur.length<4)return;if(cur.slice(0,4)===answer){solved=true;score++;updScore();$('#result').show();$('#answerZone').css('border-color','#16a34a');const sec=Math.floor((Date.now()-startTime)/1000);end('solved',sec);} }
});
</script>
</body>
</html>
